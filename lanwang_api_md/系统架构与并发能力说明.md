# 系统架构与并发能力说明

> 更新日期：2026-02-10
> 适用范围：居间交易平台（居间人端 + 工厂端）

---

## 一、当前系统技术栈

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 后端框架 | FastAdmin + ThinkPHP | 1.6.1 / 5.0.28 | MVC多模块架构 |
| 运行环境 | PHP | 8.1 | 需 json/curl/pdo/bcmath 扩展 |
| 数据库 | MySQL | 5.7+ | 远程 122.51.106.231:3306，库名 andone |
| 缓存 | File Cache | - | ThinkPHP 内置文件缓存，写入 /runtime/cache/ |
| 消息队列 | Redis Queue | - | 队列配置已就绪（127.0.0.1:6379） |
| 前端框架 | UniApp (Vue.js) | - | 跨端小程序/H5/App |
| 物联网通信 | MQTT | - | 设备状态/事件通信（110.42.230.141:1883） |
| 支付 | 微信支付 | - | 通过 xiluxc 插件集成 |
| 认证 | Token (MySQL) | - | hash_hmac ripemd160 签名验证 |

---

## 二、系统模块架构

```
┌─────────────────────────────────────────────────┐
│                   UniApp 前端                     │
│         （居间人端 / 工厂端 / H5 / 小程序）         │
└────────────────────┬────────────────────────────┘
                     │ HTTP API
┌────────────────────▼────────────────────────────┐
│              API 层 (application/api)             │
│                                                   │
│  ┌─────────────┐  ┌──────────────┐               │
│  │  居间人模块   │  │   工厂模块    │               │
│  │ JjOrder      │  │ FcOrder      │               │
│  │ JjProduct    │  │ FcProduct    │               │
│  │ JjBid        │  │ FcBid        │               │
│  │ JjAgent      │  │ FcAgent      │               │
│  │ JjCommission │  │ FcDashboard  │               │
│  │ JjBuyerInfo  │  │ FcFactory    │               │
│  │ JjDistrib... │  │              │               │
│  │ JjPkPool     │  │              │               │
│  │ JjRedPacket  │  │              │               │
│  │ JjWish       │  │              │               │
│  └─────────────┘  └──────────────┘               │
│                                                   │
│  ┌─────────────────────────────────┐             │
│  │          公共模块                 │             │
│  │ User / Shop / Pay / Order /     │             │
│  │ Coupon / Message / Recharge ... │             │
│  └─────────────────────────────────┘             │
└────────────────────┬────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────┐
│           XiluxcApi 基类 (Token 鉴权)             │
└────────────────────┬────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────┐
│              Model 层 (common/model/jj)           │
│  Order / Product / Factory / Deposit / Contract  │
│  Logistics / Commission / BidQuote / OrderLog    │
│  AgentProfile / BuyerInfo / Invite ...           │
└────────────────────┬────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────┐
│              MySQL (122.51.106.231)               │
│  17 张 fa_jj_* 业务表 + FastAdmin 系统表          │
└─────────────────────────────────────────────────┘
```

---

## 三、API 控制器清单

### 工厂端（6个控制器）

| 控制器 | 接口数 | 功能 |
|--------|--------|------|
| FcFactory | 2 | 企业认证提交/状态查询 |
| FcProduct | 4 | 产品CRUD/上下架 |
| FcOrder | 7 | 订单列表/详情/确认/锁定佣金/审核合同/发货/放款 |
| FcBid | 3 | 竞标列表/详情/报价 |
| FcAgent | 2 | 居间人列表/详情 |
| FcDashboard | 3 | 总览/产品统计/财务统计 |

### 居间人端（10个控制器）

| 控制器 | 功能 |
|--------|------|
| JjOrder | 订单管理 |
| JjProduct | 产品浏览 |
| JjBid | 竞标管理 |
| JjAgent | 居间人资料 |
| JjCommission | 佣金管理 |
| JjBuyerInfo | 买家信息管理 |
| JjDistribution | 分销推广 |
| JjPkPool | PK竞技池 |
| JjRedPacket | 红包 |
| JjWish | 心愿目标 |

---

## 四、数据库索引优化（已完成）

### 新增复合索引

| 表 | 索引名 | 字段组合 | 覆盖场景 |
|----|--------|----------|----------|
| fa_jj_order | idx_factory_status | (factory_id, status) | 工厂订单列表/状态计数/待办统计 |
| fa_jj_order | idx_factory_commission | (factory_id, commission_locked, commission_lock_time) | 锁定佣金查询/平均响应时间 |
| fa_jj_product | idx_factory_status | (factory_id, status) | 产品上下架统计 |
| fa_jj_contract | idx_order_status | (order_id, status) | 待审核合同 JOIN 查询 |
| fa_jj_bid_quote | idx_factory_status | (factory_id, status) | 竞标响应率统计 |

### 原有索引

| 表 | 索引 |
|----|------|
| fa_jj_order | PRIMARY, uk_order_sn, idx_agent_id, idx_factory_id, idx_bid_id, idx_status_createtime |
| fa_jj_product | PRIMARY, idx_factory_id, idx_category_id, idx_status_sort |
| fa_jj_deposit | PRIMARY, idx_order_id, idx_user_id, idx_pay_status |
| fa_jj_contract | PRIMARY, idx_order_id |
| fa_jj_logistics | PRIMARY, idx_order_id |
| fa_jj_bid_quote | PRIMARY, idx_bid_id, idx_factory_id |
| fa_jj_commission | PRIMARY, idx_order_id, idx_agent_id, idx_status_createtime |
| fa_jj_order_log | PRIMARY, idx_order_id |

---

## 五、查询优化（已完成）

### FcOrder/index — 订单列表状态计数

```
优化前：6条独立 COUNT(*) WHERE status = ?
优化后：1条 SELECT status, COUNT(*) GROUP BY status
减少：  5条SQL
```

### FcDashboard/overview — 数据总览

```
优化前：7条独立查询（3个聚合 + 1个AVG + 3个COUNT）
优化后：3条查询
  - 1条条件聚合（月订单量+月交易额+总订单数 合并为 SUM(IF(...))）
  - 1条AVG（平均响应时间，保留不变）
  - 1条GROUP BY（3个待办计数合并）
减少：  4条SQL
```

### FcDashboard/product_stats — 产品统计

```
优化前：4条查询（2个产品COUNT + 2个竞标COUNT）
优化后：2条查询
  - 产品上下架：1条 GROUP BY status
  - 竞标响应率：1条 SUM(IF(...)) 条件聚合
减少：  2条SQL
```

### FcOrder/todo_count — 待办事项

```
优化前：5条查询（含 whereExists/whereNotExists 子查询）
优化后：2条查询
  - 1条 GROUP BY status（简单状态计数）
  - 1条 LEFT JOIN + SUM(IF(...))（合同待审核+待发货）
减少：  3条SQL
```

### 优化总计

| 指标 | 优化前 | 优化后 | 减少比例 |
|------|--------|--------|----------|
| overview 查询数 | 7 | 3 | -57% |
| order/index 计数查询 | 6 | 1 | -83% |
| product_stats 查询数 | 4 | 2 | -50% |
| todo_count 查询数 | 5 | 2 | -60% |
| **总计** | **22** | **8** | **-64%** |

---

## 六、缓存策略（已完成）

### 缓存端点

| 接口 | 缓存Key | TTL | 说明 |
|------|---------|-----|------|
| FcDashboard/overview | fc_overview_{工厂ID} | 60秒 | 首页总览数据 |
| FcDashboard/product_stats | fc_prodstats_{工厂ID} | 120秒 | 产品统计（变化频率低） |
| FcDashboard/finance_stats | fc_finance_{工厂ID} | 60秒 | 财务统计 |
| FcOrder/todo_count | fc_todo_{工厂ID} | 30秒 | 待办计数（时效敏感） |

### 缓存失效机制

以下5个订单状态变更方法在事务提交后自动清除该工厂的全部缓存：

| 方法 | 触发场景 |
|------|----------|
| FcOrder/confirm | 工厂确认接单 |
| FcOrder/lock_commission | 工厂锁定佣金 |
| FcOrder/review_contract | 工厂审核合同 |
| FcOrder/confirm_shipment | 工厂确认发货 |
| FcOrder/release_payment | 工厂同意放款 |

清除的缓存Key：`fc_overview_*`, `fc_finance_*`, `fc_todo_*`, `fc_prodstats_*`

### 当前缓存驱动

- **开发环境**：File Cache（文件缓存，写入 runtime/cache/）
- **生产环境**：需切换为 Redis（修改 application/config.php 中 cache.type 为 redis）

---

## 七、并发能力评估

### 当前开发环境（php -S 单线程）

| 指标 | 数值 |
|------|------|
| 并发处理能力 | 1 个请求/次（串行） |
| 同时在线用户 | 1-3 人 |
| 瓶颈 | PHP 内置服务器单线程，无法并行处理请求 |
| 适用场景 | 仅限本地开发调试 |

### 生产环境部署后预估（同机 Nginx + PHP-FPM + MySQL）

#### P1 级别 — 基础部署（不加 Redis）

| 配置 | 说明 |
|------|------|
| 服务器 | 2核4G 云服务器（与MySQL同机） |
| PHP-FPM | 固定 20 worker 进程 |
| Nginx | 反向代理 + 静态资源 |
| 缓存 | File Cache（当前状态） |

| 指标 | 数值 |
|------|------|
| QPS（每秒请求数） | 80-150 |
| 同时在线用户 | 100-300 人 |
| 单请求响应时间 | 30-80ms（同机MySQL延迟 < 0.1ms） |
| dashboard 页响应 | 50-100ms（3条优化SQL + 文件缓存） |
| 订单列表页响应 | 40-80ms（分页 + 1条计数SQL） |

#### P2 级别 — 标准生产部署（加 Redis）

| 配置 | 说明 |
|------|------|
| 服务器 | 2核4G 或 4核8G 云服务器 |
| PHP-FPM | 动态 10-50 worker 进程 |
| Nginx | 反向代理 + gzip + keepalive |
| 缓存 | Redis（亚毫秒级读取） |
| MySQL | Unix Socket 连接（同机） |

| 指标 | 数值 |
|------|------|
| QPS（每秒请求数） | 300-800 |
| 同时在线用户 | **800-2000 人** |
| 缓存命中时响应 | 5-15ms（Redis读取 + JSON序列化） |
| 缓存未命中响应 | 30-60ms（优化SQL + Redis写入） |
| dashboard 页响应 | 8-20ms（缓存命中率 > 90%） |
| 订单列表页响应 | 30-60ms（分页查询不缓存） |

#### P3 级别 — 高并发部署

| 配置 | 说明 |
|------|------|
| 服务器 | 4核8G 应用 + 独立数据库服务器 |
| PHP-FPM | 动态 20-100 worker 进程 |
| Nginx | 负载均衡 + CDN 静态资源 |
| 缓存 | Redis 集群 |
| MySQL | 主从读写分离 |
| 额外 | OPcache 开启 + 连接池 |

| 指标 | 数值 |
|------|------|
| QPS（每秒请求数） | 1000-3000 |
| 同时在线用户 | **3000-8000 人** |
| 缓存命中时响应 | 3-8ms |

### 性能对比总览

| 部署方式 | SQL/页面 | 缓存 | QPS | 同时在线 |
|----------|----------|------|-----|----------|
| 开发环境（当前） | 8条（优化后） | 文件 | 1-3 | 1-3人 |
| P1 基础生产 | 8条 | 文件 | 80-150 | 100-300人 |
| **P2 标准生产** | **缓存命中0条** | **Redis** | **300-800** | **800-2000人** |
| P3 高并发 | 缓存命中0条 | Redis集群 | 1000-3000 | 3000-8000人 |

---

## 八、代码层已完成的优化清单

| # | 优化项 | 文件 | 效果 |
|---|--------|------|------|
| 1 | 订单列表状态计数合并 | FcOrder.php | 6条SQL → 1条 |
| 2 | 数据总览查询合并 | FcDashboard.php | 7条SQL → 3条 |
| 3 | 产品统计查询合并 | FcDashboard.php | 4条SQL → 2条 |
| 4 | 待办事项查询优化 | FcOrder.php | 5条SQL(含子查询) → 2条(JOIN) |
| 5 | overview 缓存 60s | FcDashboard.php | 高频接口缓存 |
| 6 | product_stats 缓存 120s | FcDashboard.php | 低频变化接口缓存 |
| 7 | finance_stats 缓存 60s | FcDashboard.php | 财务数据缓存 |
| 8 | todo_count 缓存 30s | FcOrder.php | 待办数据短时缓存 |
| 9 | 5个状态变更方法缓存失效 | FcOrder.php | 数据一致性保证 |
| 10 | 5个数据库复合索引 | 远程MySQL | 查询性能提升 |
| 11 | 金额千分位格式化 | 6个Fc控制器 | 服务端统一格式化 |

---

## 九、P2 级别部署操作手册（800-2000 并发用户）

> 目标服务器：122.51.106.231（与MySQL同机）
> 操作系统：CentOS 7/8 或 Ubuntu 20.04/22.04
> 预计操作耗时：人工约2小时，AI辅助约30分钟

### 9.1 服务器要求

| 资源 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核 |
| 内存 | 4GB | 8GB |
| 磁盘 | 50GB SSD | 100GB SSD |
| 带宽 | 5Mbps | 10Mbps |

### 9.2 手动操作步骤

#### 步骤一：安装基础软件

```bash
# ===== Ubuntu/Debian =====
sudo apt update
sudo apt install -y nginx redis-server

# 安装 PHP 8.1 + 必要扩展
sudo apt install -y software-properties-common
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update
sudo apt install -y php8.1-fpm php8.1-mysql php8.1-redis php8.1-bcmath \
    php8.1-curl php8.1-json php8.1-mbstring php8.1-xml php8.1-zip php8.1-opcache

# ===== CentOS/AlmaLinux =====
sudo yum install -y epel-release
sudo yum install -y https://rpms.remirepo.net/enterprise/remi-release-$(rpm -E %rhel).rpm
sudo yum module enable php:remi-8.1 -y
sudo yum install -y nginx redis php81-php-fpm php81-php-mysqlnd php81-php-redis \
    php81-php-bcmath php81-php-json php81-php-mbstring php81-php-xml php81-php-opcache
```

#### 步骤二：上传项目代码

```bash
# 创建项目目录
sudo mkdir -p /var/www/xiluxc
sudo chown -R www-data:www-data /var/www/xiluxc   # Ubuntu
# sudo chown -R nginx:nginx /var/www/xiluxc        # CentOS

# 方式1：Git 拉取
cd /var/www/xiluxc
git clone <你的仓库地址> .

# 方式2：SCP 上传（从本地）
scp -r /Users/wujilingtong/CYProject/LanshanNet/xiche.zzlanshan.site_wdfXr/* root@122.51.106.231:/var/www/xiluxc/

# 设置目录权限
sudo chmod -R 755 /var/www/xiluxc
sudo chmod -R 777 /var/www/xiluxc/runtime
sudo chmod -R 777 /var/www/xiluxc/public/uploads
```

#### 步骤三：配置 Nginx

创建文件 `/etc/nginx/conf.d/xiluxc.conf`：

```nginx
server {
    listen 80;
    server_name 122.51.106.231;   # 替换为实际域名或IP
    root /var/www/xiluxc/public;
    index index.php index.html;

    charset utf-8;
    client_max_body_size 20m;

    # Gzip 压缩（JSON响应体压缩60-70%）
    gzip on;
    gzip_types application/json text/plain text/css application/javascript;
    gzip_min_length 256;
    gzip_comp_level 6;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot)$ {
        expires 7d;
        access_log off;
        add_header Cache-Control "public, immutable";
    }

    # 上传文件目录
    location /uploads/ {
        expires 30d;
        access_log off;
    }

    # PHP 路由（ThinkPHP URL 重写）
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_connect_timeout 10s;
        fastcgi_send_timeout 30s;
        fastcgi_read_timeout 30s;
        fastcgi_buffering on;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 16 16k;
    }

    # 安全：禁止访问隐藏文件和敏感目录
    location ~ /\. { deny all; }
    location ~ ^/(application|runtime|thinkphp|vendor|extend)/ { deny all; }

    # Keepalive 长连接
    keepalive_timeout 65;
    keepalive_requests 1000;
}
```

```bash
# 检查配置语法
sudo nginx -t

# 删除默认站点（避免冲突）
sudo rm -f /etc/nginx/sites-enabled/default

# 重载 Nginx
sudo systemctl enable nginx
sudo systemctl restart nginx
```

#### 步骤四：配置 PHP-FPM

编辑 `/etc/php/8.1/fpm/pool.d/www.conf`（Ubuntu）或对应路径：

```ini
[www]
user = www-data
group = www-data
listen = /run/php/php8.1-fpm.sock
listen.owner = www-data
listen.group = www-data

; ===== 进程管理（按服务器内存调整）=====
; 4GB内存推荐：
pm = dynamic
pm.max_children = 30
pm.start_servers = 8
pm.min_spare_servers = 4
pm.max_spare_servers = 16
pm.max_requests = 1000

; 8GB内存推荐：
; pm.max_children = 50
; pm.start_servers = 10
; pm.min_spare_servers = 5
; pm.max_spare_servers = 20

; 慢日志
slowlog = /var/log/php-fpm-slow.log
request_slowlog_timeout = 3s
request_terminate_timeout = 30s
```

#### 步骤五：开启 OPcache

编辑 `/etc/php/8.1/fpm/conf.d/10-opcache.ini`：

```ini
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=10000
opcache.validate_timestamps=0          ; 生产环境关闭（代码更新后需重启FPM）
opcache.save_comments=1                ; FastAdmin 需要注释解析
opcache.enable_file_override=1
```

> **注意**：`validate_timestamps=0` 意味着修改PHP代码后必须执行 `sudo systemctl restart php8.1-fpm` 才能生效。如果需要频繁改代码，可设为 `1`。

```bash
sudo systemctl enable php8.1-fpm
sudo systemctl restart php8.1-fpm
```

#### 步骤六：配置 Redis

```bash
# 编辑 Redis 配置
sudo vim /etc/redis/redis.conf
```

修改以下项：

```conf
# 绑定本地（安全）
bind 127.0.0.1
# 设置密码（推荐）
requirepass xiluxc_redis_2026
# 内存限制
maxmemory 256mb
maxmemory-policy allkeys-lru
# 持久化（可选关闭提升性能）
# save ""
```

```bash
sudo systemctl enable redis-server    # Ubuntu
# sudo systemctl enable redis         # CentOS
sudo systemctl restart redis-server
```

#### 步骤七：修改项目配置文件

**7a. 修改 `.env`（项目根目录）**

```ini
[app]
debug = false
trace = false

[database]
hostname = localhost
database = andone
username = andone
password = Dp6MT3XnJiA7nP2p
hostport = 3306
prefix = fa_
```

**7b. 修改 `application/config.php` — 缓存改为 Redis**

找到 `'cache'` 配置段，替换为：

```php
'cache' => [
    'type'     => 'Redis',
    'host'     => '127.0.0.1',
    'port'     => 6379,
    'password' => 'xiluxc_redis_2026',
    'timeout'  => 1,
    'prefix'   => 'xiluxc_',
    'expire'   => 3600,
],
```

**7c. 修改 `application/config.php` — Session 改为 Redis（可选但推荐）**

```php
'session' => [
    'type'       => 'Redis',
    'host'       => '127.0.0.1',
    'port'       => 6379,
    'password'   => 'xiluxc_redis_2026',
    'prefix'     => 'sess_',
    'expire'     => 7200,
],
```

**7d. 关闭 PHP 错误显示**

编辑 `/etc/php/8.1/fpm/php.ini`：

```ini
display_errors = Off
error_reporting = E_ALL & ~E_NOTICE & ~E_DEPRECATED
log_errors = On
error_log = /var/log/php_errors.log
```

#### 步骤八：安全加固

```bash
# .env 文件仅 owner 可读
chmod 600 /var/www/xiluxc/.env

# runtime 日志仅 PHP 进程可写
chown -R www-data:www-data /var/www/xiluxc/runtime

# MySQL 禁止远程 root（在MySQL中执行）
# DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
# FLUSH PRIVILEGES;
```

#### 步骤九：验证部署

```bash
# 1. 检查各服务运行状态
sudo systemctl status nginx
sudo systemctl status php8.1-fpm
sudo systemctl status redis-server

# 2. 测试 API 接口
curl -s "http://122.51.106.231/api/xiluxc.fc_dashboard/overview" \
    -H "token: fc-lanxingyue-token-2026" | python3 -m json.tool

# 3. 验证 Redis 缓存生效
redis-cli -a xiluxc_redis_2026 KEYS 'xiluxc_*'
# 应看到 fc_overview_* 等key

# 4. 第二次请求应明显更快（命中缓存）
curl -s -o /dev/null -w "Time: %{time_total}s\n" \
    "http://122.51.106.231/api/xiluxc.fc_dashboard/overview" \
    -H "token: fc-lanxingyue-token-2026"

# 5. 检查 PHP-FPM 错误日志
sudo tail -20 /var/log/php-fpm-slow.log
sudo tail -20 /var/log/php_errors.log

# 6. 检查 Nginx 错误日志
sudo tail -20 /var/log/nginx/error.log
```

### 9.3 P2 部署 Checklist

- [ ] Nginx 安装并配置虚拟主机
- [ ] PHP 8.1-FPM 安装并配置进程池
- [ ] OPcache 开启
- [ ] Redis 安装并设置密码
- [ ] 项目代码上传至 /var/www/xiluxc/
- [ ] runtime/ 和 public/uploads/ 目录可写
- [ ] .env 改为 debug=false，数据库改为 localhost
- [ ] config.php 缓存驱动改为 Redis
- [ ] PHP display_errors = Off
- [ ] .env 文件权限 600
- [ ] Nginx 禁止访问敏感目录
- [ ] API 接口测试通过
- [ ] Redis 缓存 Key 验证生效

### 9.4 使用 AI 工具辅助部署（P2）

如果你使用 Claude Code 或其他 AI 编程助手，可以 SSH 连接到服务器后，直接给 AI 以下指令：

#### 指令一：一键安装环境

```
请帮我在当前 Ubuntu 服务器上安装以下软件：
1. Nginx
2. PHP 8.1-FPM 以及扩展：mysql, redis, bcmath, curl, json, mbstring, xml, opcache
3. Redis Server

安装完成后启用所有服务的开机自启。
```

#### 指令二：配置 Nginx

```
请帮我创建 Nginx 虚拟主机配置文件 /etc/nginx/conf.d/xiluxc.conf，要求：
- 监听 80 端口
- 根目录 /var/www/xiluxc/public
- ThinkPHP URL 重写规则
- PHP 请求转发到 PHP-FPM Unix Socket
- 开启 Gzip 压缩（json/css/js）
- 静态资源缓存 7 天
- 禁止访问 .env 和 application/runtime/vendor 等敏感目录
- Keepalive 长连接

然后检查语法并重启 Nginx。
```

#### 指令三：配置 PHP-FPM + OPcache

```
请帮我优化 PHP-FPM 配置：
- 当前服务器是 4核8G
- 使用 dynamic 模式，max_children=50
- 开启慢日志（3秒阈值）
- 开启 OPcache（128M内存，生产模式 validate_timestamps=0）
- 关闭 display_errors，开启 error_log

修改完后重启 PHP-FPM。
```

#### 指令四：配置 Redis 并修改项目配置

```
请帮我完成以下操作：
1. Redis 设置密码为 xiluxc_redis_2026，内存限制 256MB，淘汰策略 allkeys-lru
2. 修改项目 /var/www/xiluxc/.env：debug=false，数据库 hostname 改为 localhost
3. 修改项目 /var/www/xiluxc/application/config.php：
   - cache.type 改为 Redis，host=127.0.0.1，port=6379，password=xiluxc_redis_2026，prefix=xiluxc_
4. 重启 Redis 和 PHP-FPM
5. 测试 API 接口验证部署成功
```

#### 指令五：安全加固

```
请帮我完成服务器安全加固：
1. .env 文件权限设为 600
2. runtime 目录 owner 设为 www-data
3. 验证 Nginx 已禁止访问敏感目录
4. 检查 PHP 已关闭错误显示
```

---

## 十、P3 级别部署操作手册（3000-8000 并发用户）

> 在 P2 基础上进行扩展，主要增加：MySQL 读写分离、多应用节点负载均衡、CDN、连接池
> 预计操作耗时：人工约4-6小时，AI辅助约1-2小时

### 10.1 P3 架构图

```
                    ┌──────────┐
                    │   CDN    │ ← 静态资源（js/css/图片）
                    └────┬─────┘
                         │
                    ┌────▼─────┐
                    │  Nginx   │ ← 负载均衡 / SSL终结
                    │ (主入口)  │
                    └────┬─────┘
                         │
              ┌──────────┼──────────┐
              ▼          ▼          ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ App节点1  │ │ App节点2  │ │ App节点N  │
        │ PHP-FPM  │ │ PHP-FPM  │ │ PHP-FPM  │
        └────┬─────┘ └────┬─────┘ └────┬─────┘
             │            │            │
        ┌────▼────────────▼────────────▼────┐
        │            Redis Sentinel          │
        │     （缓存 + Session 共享）          │
        └────────────────┬──────────────────┘
                         │
              ┌──────────┼──────────┐
              ▼                     ▼
        ┌──────────┐          ┌──────────┐
        │  MySQL   │  ←复制→  │  MySQL   │
        │  主库    │          │  从库    │
        │ (读+写)  │          │ (只读)   │
        └──────────┘          └──────────┘
```

### 10.2 服务器要求

| 角色 | 配置 | 数量 |
|------|------|------|
| Nginx 负载均衡 | 2核4G | 1台（可与App节点合用） |
| App 应用节点 | 4核8G | 2-3台 |
| MySQL 主库 | 4核16G | 1台（现有 122.51.106.231） |
| MySQL 从库 | 2核8G | 1台 |
| Redis | 2核4G | 1台（可与App节点合用） |

> **最小 P3 方案**（2台服务器）：现有服务器做 MySQL主库+Redis，新增1台 4核8G 做 Nginx+PHP-FPM+MySQL从库。

### 10.3 手动操作步骤

#### 步骤一：MySQL 主从复制配置

**在主库（122.51.106.231）上操作：**

```bash
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
```

添加/修改：

```ini
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
binlog-do-db = andone
expire_logs_days = 7

# 性能优化
innodb_buffer_pool_size = 4G        # 物理内存的50-70%
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2  # 提升写入性能（轻微降低持久性）
innodb_flush_method = O_DIRECT
max_connections = 500
```

```bash
sudo systemctl restart mysql
```

```sql
-- 在主库 MySQL 中执行：创建复制专用账号
CREATE USER 'repl_user'@'%' IDENTIFIED BY 'ReplPass_2026!';
GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'%';
FLUSH PRIVILEGES;

-- 记录当前 binlog 位置
SHOW MASTER STATUS;
-- 记下 File 和 Position 值，例如：mysql-bin.000001, 154
```

**在从库上操作：**

```bash
# 安装 MySQL（从库服务器）
sudo apt install -y mysql-server

sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
```

```ini
[mysqld]
server-id = 2
relay-log = relay-bin
read_only = 1
super_read_only = 1
innodb_buffer_pool_size = 2G
max_connections = 300
```

```bash
sudo systemctl restart mysql
```

```sql
-- 在从库 MySQL 中执行：
CHANGE MASTER TO
    MASTER_HOST = '122.51.106.231',
    MASTER_USER = 'repl_user',
    MASTER_PASSWORD = 'ReplPass_2026!',
    MASTER_LOG_FILE = 'mysql-bin.000001',    -- 替换为主库的 File 值
    MASTER_LOG_POS = 154;                     -- 替换为主库的 Position 值

START SLAVE;

-- 验证复制状态（两个 Yes 表示正常）
SHOW SLAVE STATUS\G
-- Slave_IO_Running: Yes
-- Slave_SQL_Running: Yes
```

#### 步骤二：ThinkPHP 配置读写分离

修改项目 `application/database.php`：

```php
return [
    'type'        => 'mysql',
    'deploy'      => 1,              // 开启分布式（读写分离）
    'rw_separate' => true,           // 读写分离
    'master_num'  => 1,              // 主库数量
    'slave_no'    => '',             // 从库序号（空=随机）

    // 主库,从库 用逗号分隔
    'hostname'    => 'localhost,从库IP地址',
    'database'    => 'andone',
    'username'    => 'andone,readonly_user',
    'password'    => 'Dp6MT3XnJiA7nP2p,ReadOnlyPass_2026',
    'hostport'    => '3306',
    'prefix'      => 'fa_',
    'charset'     => 'utf8mb4',

    // 其余配置保持不变
    'params'      => [],
    'debug'       => false,
];
```

> **原理**：ThinkPHP 5 内置读写分离支持。配置后 SELECT 查询自动走从库，INSERT/UPDATE/DELETE 自动走主库。

#### 步骤三：Nginx 负载均衡（多 App 节点时）

如果有多台 App 应用服务器，修改 Nginx 配置：

```nginx
upstream app_backend {
    # 加权轮询
    server 192.168.1.10:9000 weight=3;   # App节点1（4核8G，权重高）
    server 192.168.1.11:9000 weight=2;   # App节点2（2核4G）

    # 健康检查：失败2次后暂停30秒
    # 需要 nginx-plus 或 lua 模块，开源版用 max_fails
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain.com;
    root /var/www/xiluxc/public;

    location ~ \.php$ {
        fastcgi_pass app_backend;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_keep_conn on;
    }

    # 其余配置同 P2
}
```

> **单台服务器方案**：如果只有一台 App 服务器，无需负载均衡，使用 P2 的 Nginx 配置即可。P3 的核心收益来自读写分离和 Redis。

#### 步骤四：Redis Sentinel（高可用，可选）

如果需要 Redis 不宕机，配置 Sentinel：

```bash
# /etc/redis/sentinel.conf
sentinel monitor mymaster 127.0.0.1 6379 1
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
sentinel auth-pass mymaster xiluxc_redis_2026
```

> **最小方案**：单机 Redis 已足够支撑 P3 流量（Redis 单实例可处理 10万+ QPS）。Sentinel 仅在要求零宕机时部署。

#### 步骤五：CDN 配置静态资源

推荐使用腾讯云CDN / 阿里云CDN / Cloudflare：

1. CDN 回源地址设为 `http://122.51.106.231`
2. 缓存规则：
   - `/assets/*` → 缓存 30 天
   - `/uploads/*` → 缓存 7 天
   - `/api/*` → 不缓存（回源）
3. Nginx 中为静态资源添加 CORS 头：

```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot)$ {
    expires 30d;
    add_header Access-Control-Allow-Origin *;
    add_header Cache-Control "public, immutable";
}
```

#### 步骤六：MySQL 额外索引（P3 专用）

```sql
-- 居间人端高频查询索引
ALTER TABLE fa_jj_order ADD INDEX idx_agent_status (agent_id, status);
ALTER TABLE fa_jj_order ADD INDEX idx_factory_createtime (factory_id, createtime);

-- 保证金复合索引
ALTER TABLE fa_jj_deposit ADD INDEX idx_order_paystatus (order_id, pay_status);

-- 物流复合索引
ALTER TABLE fa_jj_logistics ADD INDEX idx_order_status (order_id, status);

-- 居间人画像索引
ALTER TABLE fa_jj_agent_profile ADD INDEX idx_status_score (status, credit_score);
ALTER TABLE fa_jj_agent_profile ADD INDEX idx_user_id (user_id);
```

#### 步骤七：开启 MySQL 慢查询日志

```sql
-- 在 MySQL 中执行
SET GLOBAL slow_query_log = 1;
SET GLOBAL long_query_time = 1;                    -- 超过1秒记录
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
```

或在 `my.cnf` 中永久配置：

```ini
[mysqld]
slow_query_log = 1
long_query_time = 1
slow_query_log_file = /var/log/mysql/slow.log
```

#### 步骤八：PHP-FPM 进程池调优（P3 级别）

```ini
[www]
pm = dynamic
pm.max_children = 80              ; 8GB内存可支撑80个worker
pm.start_servers = 20
pm.min_spare_servers = 10
pm.max_spare_servers = 40
pm.max_requests = 2000

; 开启状态页（用于监控）
pm.status_path = /fpm-status
ping.path = /fpm-ping
```

### 10.4 P3 部署 Checklist

#### 基础（在 P2 基础上）

- [ ] P2 全部 Checklist 已完成

#### MySQL 读写分离

- [ ] 主库开启 binlog（ROW 格式）
- [ ] 从库安装 MySQL 并配置 read_only
- [ ] 复制账号创建 + CHANGE MASTER 配置
- [ ] SHOW SLAVE STATUS 验证两个 Yes
- [ ] ThinkPHP database.php 配置 deploy=1, rw_separate=true
- [ ] 测试写操作走主库、读操作走从库

#### 性能调优

- [ ] MySQL innodb_buffer_pool_size 设为物理内存 50-70%
- [ ] PHP-FPM max_children 调高（80+）
- [ ] MySQL 慢查询日志开启
- [ ] P3 额外索引执行完成

#### CDN（可选）

- [ ] CDN 服务开通并配置回源
- [ ] 静态资源缓存规则验证
- [ ] API 路径不缓存验证

### 10.5 使用 AI 工具辅助部署（P3）

#### 指令一：MySQL 主从复制

```
请帮我配置 MySQL 主从复制：
- 主库 IP：122.51.106.231，已有数据库 andone
- 从库 IP：[填写从库IP]，需要新安装 MySQL
- 使用 ROW 格式 binlog
- 创建复制专用账号 repl_user
- 完成后验证 SHOW SLAVE STATUS 中 IO 和 SQL 线程都是 Yes
```

#### 指令二：ThinkPHP 读写分离配置

```
请帮我修改 /var/www/xiluxc/application/database.php，配置 ThinkPHP 5 的读写分离：
- 主库：localhost（当前服务器）
- 从库：[从库IP]
- 从库只读账号：readonly_user / ReadOnlyPass_2026
- 开启 deploy=1, rw_separate=true
修改完后重启 PHP-FPM。
```

#### 指令三：性能调优

```
请帮我优化当前服务器的数据库和 PHP 性能：
1. MySQL innodb_buffer_pool_size 设为物理内存的 60%
2. MySQL 开启慢查询日志（阈值1秒）
3. PHP-FPM max_children 调整为 80
4. 执行以下额外索引 SQL：
   ALTER TABLE fa_jj_order ADD INDEX idx_agent_status (agent_id, status);
   ALTER TABLE fa_jj_deposit ADD INDEX idx_order_paystatus (order_id, pay_status);
   ALTER TABLE fa_jj_logistics ADD INDEX idx_order_status (order_id, status);
   ALTER TABLE fa_jj_agent_profile ADD INDEX idx_status_score (status, credit_score);
5. 修改完后重启 MySQL 和 PHP-FPM
```

#### 指令四：CDN 配置验证

```
请帮我验证 CDN 是否正常工作：
1. 测试静态资源是否通过 CDN 返回（检查 response header 中的 X-Cache 或 Via）
2. 测试 API 请求是否绕过 CDN 直接回源
3. 检查 Nginx 日志中静态资源请求是否明显减少
```

---

## 十一、运维监控方案

### 日常监控命令

```bash
# ===== 服务状态 =====
sudo systemctl status nginx php8.1-fpm redis-server mysql

# ===== PHP-FPM 进程数 =====
ps aux | grep php-fpm | grep -v grep | wc -l

# ===== Redis 监控 =====
redis-cli -a xiluxc_redis_2026 INFO stats | grep instantaneous_ops_per_sec
redis-cli -a xiluxc_redis_2026 INFO memory | grep used_memory_human
redis-cli -a xiluxc_redis_2026 DBSIZE

# ===== MySQL 连接数 =====
mysql -u andone -pDp6MT3XnJiA7nP2p -e "SHOW STATUS LIKE 'Threads_connected';"
mysql -u andone -pDp6MT3XnJiA7nP2p -e "SHOW STATUS LIKE 'Slow_queries';"

# ===== Nginx 连接数 =====
ss -s | grep estab

# ===== 系统负载 =====
uptime
free -h
df -h

# ===== 错误日志 =====
sudo tail -20 /var/log/nginx/error.log
sudo tail -20 /var/log/php_errors.log
sudo tail -20 /var/log/php-fpm-slow.log
sudo tail -20 /var/log/mysql/slow.log
```

### 告警阈值建议

| 指标 | 警告阈值 | 严重阈值 |
|------|----------|----------|
| CPU 使用率 | > 70% | > 90% |
| 内存使用率 | > 75% | > 90% |
| 磁盘使用率 | > 80% | > 95% |
| PHP-FPM 活跃进程 | > max_children × 80% | = max_children |
| MySQL 慢查询/小时 | > 50 | > 200 |
| Redis 内存使用 | > maxmemory × 80% | > maxmemory × 95% |
| API 平均响应时间 | > 200ms | > 1000ms |

### 使用 AI 工具设置监控

```
请帮我写一个 Shell 脚本 /usr/local/bin/server_monitor.sh，每5分钟执行一次（cron），检查：
1. Nginx / PHP-FPM / Redis / MySQL 服务是否存活，不存活则自动重启并记录日志
2. CPU/内存/磁盘使用率是否超过阈值
3. PHP-FPM 活跃进程数是否接近上限
4. 将监控结果写入 /var/log/server_monitor.log
5. 配置 crontab 定时执行
```

---

## 十二、P2/P3 优化效果对比总览

| 指标 | 开发环境(当前) | P2 部署后 | P3 部署后 |
|------|--------------|-----------|-----------|
| Web 服务器 | php -S 单线程 | Nginx + PHP-FPM | Nginx 负载均衡 |
| PHP 进程数 | 1 | 30-50 | 80+ |
| 缓存 | File | Redis | Redis |
| 数据库 | 远程单库 | 同机单库 | 主从读写分离 |
| 数据库连接 | TCP 跨网 | Unix Socket | Unix Socket |
| OPcache | 关 | 开 | 开 |
| CDN | 无 | 无 | 有 |
| Gzip | 无 | 有 | 有 |
| Debug 模式 | 开 | 关 | 关 |
| QPS | 1-3 | 300-800 | 1000-3000 |
| **同时在线** | **1-3人** | **800-2000人** | **3000-8000人** |
| API 响应(缓存命中) | 200-500ms | 5-15ms | 3-8ms |
| API 响应(缓存未命中) | 200-500ms | 30-60ms | 15-40ms |

---

*文档版本：v2.0*
*编写日期：2026-02-10*
*适用项目：蓝衫网居间交易平台（居间人端 + 工厂端）*
