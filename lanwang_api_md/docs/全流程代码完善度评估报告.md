# 全流程代码完善度评估报告

> 评估日期：2026-02-15
> 评估范围：居间人端 + 工厂端 全流程（后端API、前端页面、管理后台、定时任务）

---

## 一、后端 API 完整度

### 1.1 工厂端 (FcOrder / FcWallet / FcDashboard) — ✅ 可演示

| 方法 | 文件 | 状态 | 说明 |
|------|------|------|------|
| `confirm()` 确认接单 | FcOrder.php | ✅ 完整 | STATUS_PENDING → STATUS_DEPOSIT |
| `lock_commission()` 锁定佣金 | FcOrder.php | ✅ 完整 | 含2小时超时阻断、防重复冻结 |
| `review_contract()` 审核合同 | FcOrder.php | ✅ 完整 | 通过/驳回均完整 |
| `review_payment()` 审核付款证明 | FcOrder.php | ✅ 完整 | 通过/驳回均完整 |
| `confirm_shipment()` 确认发货 | FcOrder.php | ✅ 完整 | 自动结算 + 保证金退还到居间人余额 |
| `release_payment()` 同意放款 | FcOrder.php | ✅ 完整 | 结算 + 保证金退还到居间人余额 |
| `fail_settle()` 违约结算 | FcOrder.php | ✅ 完整 | 分账逻辑完整，行锁防并发 |
| `todo_count()` 待办统计 | FcOrder.php | ✅ 完整 | 带30秒缓存 |
| `balance()` 钱包余额 | FcWallet.php | ✅ 完整 | |
| `fund_log()` 资金流水 | FcWallet.php | ✅ 完整 | |
| `create_recharge()` 创建充值 | FcWallet.php | ✅ 完整 | 微信支付已对接 |
| `notify()` 支付回调 | FcWallet.php | ✅ 完整 | 幂等+金额校验 |
| `bank_account_*` 银行卡管理 | FcWallet.php | ✅ 完整 | 增删改+设默认 |
| `create_withdraw()` 申请提现 | FcWallet.php | ✅ 完整 | |
| `withdraw_log()` 提现记录 | FcWallet.php | ✅ 完整 | |
| `escrow_list()` 托管记录 | FcWallet.php | ✅ 完整 | |
| `overview()` 仪表盘 | FcDashboard.php | ✅ 完整 | 带60秒缓存 |
| `product_stats()` 商品统计 | FcDashboard.php | ✅ 完整 | TOP10 |
| `finance_stats()` 财务统计 | FcDashboard.php | ✅ 完整 | |

**工厂端无遗留 TODO，所有方法均可正常运行。**

### 1.2 居间人端 (JjOrder / JjCommission) — ⚠️ 有2个阻断项

| 方法 | 文件 | 状态 | 说明 |
|------|------|------|------|
| `submit()` 下单 | JjOrder.php | ✅ 完整 | 单笔/批量均完整 |
| `deposit_info()` 保证金详情 | JjOrder.php | ✅ 完整 | |
| `pay_deposit()` 缴纳保证金 | JjOrder.php | ❌ 模拟支付 | `TODO: 对接实际支付`，debug模式直接标记已支付 |
| `pay_batch_deposit()` 批量缴纳 | JjOrder.php | ❌ 模拟支付 | 同上 |
| `contract_status()` 合同状态 | JjOrder.php | ✅ 完整 | 已返回 upload 和 execution 两阶段截止时间 |
| `submit_contract()` 上传合同 | JjOrder.php | ✅ 完整 | |
| `upload_payment_proof()` 上传凭证 | JjOrder.php | ⚠️ 小问题 | `logistics_method` 字段数据库可能缺列 |
| `logistics()` 物流查询 | JjOrder.php | ✅ 完整 | |
| `urge_factory()` 催促工厂 | JjOrder.php | ⚠️ 无通知 | 只写日志不发SMS/推送 |
| `upload_checklist()` 上传验收单 | JjOrder.php | ✅ 完整 | |
| `summary()` 佣金汇总 | JjCommission.php | ✅ 完整 | |
| `list()` 佣金列表 | JjCommission.php | ✅ 完整 | |

---

## 二、前端页面完整度

### 2.1 居间人端页面

| 页面 | 文件 | 状态 | 说明 |
|------|------|------|------|
| `jj_order_detail` 订单详情 | ✅ 1240行 | 完整 | 8种状态横幅、倒计时、三流跟踪 |
| `jj_contract` 合同上传 | ✅ 782行 | 完整 | 上传+倒计时+催促 |
| `jj_deposit` 保证金缴纳 | ✅ 485行 | 完整 | 单笔/批量+模拟支付 |
| `jj_payment_proof` 付款凭证 | ✅ 500行 | 完整 | 图片/PDF上传 |
| `jj_wish` 心愿目标 | ✅ 414行 | 完整 | |
| **`jj_main` 主入口页** | ❌ 缺失 | **阻断** | 多个页面跳转到此，缺失将白屏 |
| **`jj_logistics` 物流跟踪** | ❌ 缺失 | **阻断** | 订单详情和合同页引用 |
| `jj_wallet` 钱包/佣金 | ❌ 缺失 | 需补充 | |

### 2.2 工厂端页面

| 页面 | 文件 | 状态 | 说明 |
|------|------|------|------|
| `fc_order_detail` 订单详情 | ⚠️ 720行 | 可用 | 用 uni.request 而非 $core，架构不一致 |
| `fc_wallet` 工厂钱包 | ✅ 已部署 | 完整 | 在"我的"模块-功能菜单-我的钱包 |
| `fc_recharge` 充值页 | ✅ 已部署 | 完整 | |
| `fc_main` 工厂主页 | 待确认 | — | |

### 2.3 pages.json 路由

所有 `jj_*` 和 `fc_*` 页面需确认是否已在 `pages.json` 中注册路由。

---

## 三、数据模型层 — ✅ 完整

共 25 个模型文件，全部齐备：

| 分类 | 模型 | 状态 |
|------|------|------|
| 核心 | Order, Deposit, DepositBatch, Contract, Escrow, Commission | ✅ |
| 工厂 | Factory, FactoryAccount, FactoryFundLog, FactoryRechargeOrder | ✅ |
| 工厂扩展 | FactoryWithdraw, FactoryBankAccount | ✅ |
| 物流 | Logistics, PaymentProof | ✅ |
| 日志 | OrderLog | ✅ |
| 商品 | Product, Bid, BidQuote, Cart | ✅ |
| 用户 | AgentProfile, BuyerInfo, Invite | ✅ |
| 活动 | RedPacket, PkPool, PkRank | ✅ |

关键模型特性：
- `FactoryAccount`：recharge/freeze/settle/unfreeze 全部事务安全 + 行锁
- `FactoryWithdraw`：applyWithdraw + refundOnRefuse 含幂等检查
- `Escrow`：calculateSplit() 含税率/平台费/物流返佣拆分（当前税率=0）

---

## 四、管理后台 — ⚠️ 部分缺失

| 控制器 | 视图 | JS | 说明 |
|--------|------|-----|------|
| xiluxc/finance/FactoryWithdraw | ❌ 缺失 | ❌ 缺失 | 新建的控制器，无前端页面 |
| xiluxc/finance/ShopWithdraw | ✅ | ✅ | 可作为模板参考 |
| xiluxc/finance/Withdraw | ✅ | ✅ | 完整 |
| xiluxc/finance/MoneyLog | ✅ | ✅ | 完整 |
| 居间人订单管理 | ❌ 不存在 | ❌ | 后台无法查看/管理居间人订单 |

---

## 五、定时任务 — ✅ 已就绪

**命令**：`php think jj:auto_settle`
**文件**：`application/command/JjAutoSettle.php`

| 功能 | 说明 |
|------|------|
| 合同超时自动违约 | 扫描 status=3 + contract_upload_deadline 过期 |
| 催款超时自动违约 | 扫描 status=4 + payment_urge_deadline 过期 |
| 工厂超时封禁 | 扫描 status=2 + 保证金已缴>2小时 → 封禁+取消+退保证金 |

部署方式：
```
* * * * * php /path/to/think jj:auto_settle >> /tmp/jj_auto_settle.log 2>&1
```

---

## 六、已完成的修复记录

### 工厂端修复（7项）

| 编号 | 问题 | 修复内容 |
|------|------|----------|
| P0-1 | notify() 事务嵌套 | 移除外层事务包裹 |
| P0-2 | notify() platform 变量未定义 | 硬编码 'wxmini' |
| P0-3 | notify() 缺少金额校验 | 增加 result_code + total_fee 验证 |
| P0-4 | payNotify() 账户不存在 | 改用 getOrCreate() |
| P0-5 | 结算并发双重执行 | lock(true) + 状态重校验 |
| P1-7 | lock_commission 重复冻结 | 检查已有 HOLDING escrow |
| P1-9 | refundOnRefuse 双重退款 | FactoryFundLog 幂等检查 |

### 居间人端修复（3项）

| 编号 | 问题 | 修复内容 |
|------|------|----------|
| 问题2 | 保证金退还只改状态 | 增加 User::money() 退到居间人余额 |
| 问题4 | 无自动违约结算 | 创建 JjAutoSettle 定时命令 |
| 问题6 | 工厂超时封禁缺失 | lock_commission 超时阻断 + 定时封禁 |

---

## 七、演示就绪评估

### ✅ 可以演示的场景（debug 模式）

1. **完整正常流程**：居间人下单 → 模拟缴保证金 → 工厂锁定佣金 → 上传合同 → 审核 → 上传凭证 → 发货/放款 → 结算到账
2. **违约结算流程**：超时后定时任务自动处理
3. **工厂充值/提现/银行卡管理**：完整可用
4. **工厂仪表盘统计**：完整可用

### ❌ 演示前必须解决

| 优先级 | 问题 | 影响 |
|--------|------|------|
| P0 | `jj_main` 页面缺失 | 居间人端无主入口，多处跳转白屏 |
| P0 | pages.json 路由未注册 | 页面导航不可达 |
| P1 | `jj_logistics` 物流跟踪缺失 | 订单详情点击"查看物流"白屏 |
| P1 | `jj_wallet` 钱包/佣金页缺失 | 居间人无法查看收益明细 |

### 可暂时回避的问题

| 问题 | 说明 |
|------|------|
| 保证金模拟支付 | debug 模式下自动通过，演示时说明"支付环节待对接" |
| 催促工厂无通知 | 功能可点击，只是不发真实短信 |
| 管理后台 FactoryWithdraw 无视图 | 可用数据库直接查看 |
| fc_order_detail 架构不一致 | 功能可用，代码风格问题 |

---

## 八、下一步工作优先级

| 序号 | 工作项 | 优先级 | 说明 |
|------|--------|--------|------|
| 1 | 补齐 jj_main 主入口页 | P0 | Tab导航：订单列表、商品池、我的 |
| 2 | ~~补齐 jj_wallet 钱包/佣金页~~ | ~~P1~~ | ✅ 已完成 |
| 3 | ~~补齐 jj_logistics 物流跟踪页~~ | ~~P1~~ | ✅ 已完成 |
| 4 | ~~pages.json 注册路由~~ | ~~P0~~ | ✅ 已注册8个页面 |
| 5 | 管理后台 FactoryWithdraw 视图 | P2 | 参照 ShopWithdraw 模板 |
| 6 | 管理后台 居间人订单管理 | P2 | 后台查看/干预订单 |
| 7 | 保证金真实支付对接 | P0(上线前) | 微信/支付宝 |
| 8 | 催促工厂短信通知 | P2 | 对接SMS服务 |

---

## 九、补充完善记录（2026-02-15）

### 新增页面

1. **`jj_wallet.vue`** — 居间人佣金钱包页
   - 路径: `pages/jj/jj_wallet/jj_wallet.vue`
   - 功能: 佣金汇总卡片(累计/待结算/已结算) + Tab切换列表(全部/待结算/已结算) + 展开明细(基础佣金/工厂加价/物流返佣/PK奖金/红包)
   - API: `xiluxc.jj_commission/summary` + `xiluxc.jj_commission/list`
   - 支持下拉刷新 + 分页加载

2. **`jj_logistics.vue`** — 物流跟踪页
   - 路径: `pages/jj/jj_logistics/jj_logistics.vue`
   - 功能: 物流概况(平台物流/自提) + 物流时间线 + 收发货清单文件预览 + 提货凭证
   - API: `xiluxc.jj_order/logistics`
   - 参数: `orderId` 通过 URL 传递

### pages.json 路由注册

新增 8 条路由:
- `pages/jj/jj_order_detail` — 订单详情
- `pages/jj/jj_deposit` — 缴纳保证金
- `pages/jj/jj_contract` — 合同管理
- `pages/jj/jj_payment_proof` — 上传付款凭证
- `pages/jj/jj_wallet` — 我的佣金（含下拉刷新）
- `pages/jj/jj_logistics` — 物流跟踪
- `pages/jj/jj_wish` — 我的心愿
- `pages/jj/fc_order_detail` — 工厂订单详情
