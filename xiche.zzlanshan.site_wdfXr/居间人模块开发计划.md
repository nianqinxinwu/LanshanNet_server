# 居间人模块后端开发计划

## 一、Gemini 审计文档评估

### 1.1 合理之处

| 建议 | 评价 |
|------|------|
| 复用 `fa_user` 作为统一账号中心 | ✅ 合理，已在 fa_user 中添加 roleType 等字段 |
| 新建 `fa_agent_profile` 居间人扩展表 | ✅ 合理，避免继续膨胀 fa_user |
| 新建 `fa_factory_profile` 工厂扩展表 | ✅ 合理，工厂信息需要独立表 |
| 新建保证金跟踪表 | ✅ 合理，保证金有独立生命周期 |
| 新建激励奖池表 | ✅ 合理，前端 PK 奖池页面需要 |
| 商品/任务池表 | ✅ 合理，支撑商品池列表和抢单 |

### 1.2 需要纠正的问题

#### 问题一：camelCase 字段命名（严重）

Gemini 建议数据库字段全部使用 camelCase，这与项目实际不符：

- 现有 83 张表中，原始字段全部使用 **snake_case**（如 `order_no`, `user_id`, `pay_type`）
- ThinkPHP 5 的 CRUD 生成器、表单构建器、模型自动化均基于 snake_case
- `fa_user` 表中已有的 camelCase 字段（`roleType`, `agentType` 等）是历史遗留的不一致

**决策**：新表统一使用 **snake_case**，在 API 控制器层通过字段映射输出 camelCase 给前端。

#### 问题二：表名缺少业务前缀

Gemini 建议的 `fa_order`、`fa_order_logistics` 会与现有 `fa_xiluxc_order` 产生混淆。

**决策**：新表统一使用 `fa_jj_` 前缀，明确标识为居间人模块的业务表。

#### 问题三：表覆盖不完整

对照前端 21 个页面的 API 调用，Gemini 遗漏了以下关键表：

| 遗漏的表 | 对应前端页面 |
|----------|------------|
| 竞标表 | jj_bid_board / jj_bid_publish |
| 竞标报价表 | jj_bid_detail（工厂报价列表） |
| 佣金记录表 | jj_commission |
| 红包记录表 | jj_red_packet |
| 合同记录表 | jj_contract |
| PK 排名表 | jj_pk_pool（排行榜） |
| 分销/推广关系表 | jj_distribution |

---

## 二、修正后的数据库表设计

### 2.1 表清单总览（共 15 张新表）

| # | 表名 | 说明 | 对应前端页面 |
|---|------|------|------------|
| 1 | fa_jj_agent_profile | 居间人扩展信息 | jj_home, jj_profile, jj_auth |
| 2 | fa_jj_factory | 工厂信息 | jj_bid_publish, jj_product_detail |
| 3 | fa_jj_product | 商品/任务池 | jj_products, jj_product_detail |
| 4 | fa_jj_order | 居间人订单 | jj_orders, jj_order_detail |
| 5 | fa_jj_order_log | 订单状态日志 | jj_order_detail |
| 6 | fa_jj_deposit | 保证金记录 | jj_deposit |
| 7 | fa_jj_contract | 合同记录 | jj_contract |
| 8 | fa_jj_logistics | 物流跟踪 | jj_logistics |
| 9 | fa_jj_commission | 佣金记录 | jj_commission |
| 10 | fa_jj_bid | 竞标记录 | jj_bid_board, jj_bid_detail |
| 11 | fa_jj_bid_quote | 竞标工厂报价 | jj_bid_detail |
| 12 | fa_jj_red_packet | 平台红包记录 | jj_red_packet |
| 13 | fa_jj_pk_pool | PK 奖池 | jj_pk_pool |
| 14 | fa_jj_pk_rank | PK 排名记录 | jj_pk_pool |
| 15 | fa_jj_invite | 分销推广关系 | jj_distribution |

### 2.2 完整 DDL 建表语句

```sql
-- ============================================================
-- 居间人模块建表脚本
-- 数据库: andone | 字符集: utf8mb4 | 表前缀: fa_jj_
-- 命名规范: snake_case（与现有 83 张表保持一致）
-- ============================================================

-- -----------------------------------------------------------
-- 1. fa_jj_agent_profile 居间人扩展表
-- 说明: 一对一关联 fa_user，存储居间人业务属性
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_agent_profile` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_user.id',
  `real_name` varchar(50) NOT NULL DEFAULT '' COMMENT '实名',
  `credit_score` int(10) NOT NULL DEFAULT '0' COMMENT '信誉分',
  `agent_level` tinyint(3) unsigned NOT NULL DEFAULT '1' COMMENT '等级',
  `hexagon_data` json DEFAULT NULL COMMENT '雷达图六维数据JSON',
  `total_revenue` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '累计收入',
  `settled_revenue` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '已结算收入',
  `pending_revenue` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '待结算收入',
  `invite_code` varchar(20) NOT NULL DEFAULT '' COMMENT '邀请码',
  `parent_agent_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '上级居间人ID',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待审核,1=正常,2=冻结',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  UNIQUE KEY `uk_invite_code` (`invite_code`),
  KEY `idx_parent_agent_id` (`parent_agent_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='居间人扩展表';

-- -----------------------------------------------------------
-- 2. fa_jj_factory 工厂信息表
-- 说明: 一对一关联 fa_user(roleType=2)，存储工厂企业信息
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_factory` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_user.id',
  `company_name` varchar(100) NOT NULL DEFAULT '' COMMENT '企业名称',
  `license_image` varchar(255) NOT NULL DEFAULT '' COMMENT '营业执照图片',
  `province` varchar(30) NOT NULL DEFAULT '' COMMENT '省份',
  `industry` varchar(50) NOT NULL DEFAULT '' COMMENT '行业',
  `address` varchar(255) NOT NULL DEFAULT '' COMMENT '工厂地址',
  `contact_name` varchar(30) NOT NULL DEFAULT '' COMMENT '联系人',
  `contact_phone` varchar(20) NOT NULL DEFAULT '' COMMENT '联系电话',
  `fulfill_rate` decimal(5,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '履约率百分比',
  `product_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '在售商品数',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待审核,1=正常,2=冻结',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_province_industry` (`province`,`industry`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工厂信息表';

-- -----------------------------------------------------------
-- 3. fa_jj_product 商品/任务池
-- 说明: 工厂发布的商品，居间人从中接单
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_product` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `factory_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_factory.id',
  `category_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '分类ID',
  `category_name` varchar(50) NOT NULL DEFAULT '' COMMENT '分类名称',
  `name` varchar(100) NOT NULL DEFAULT '' COMMENT '商品名称',
  `cover_image` varchar(255) NOT NULL DEFAULT '' COMMENT '封面图',
  `price` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '单价',
  `unit` varchar(20) NOT NULL DEFAULT '' COMMENT '单位',
  `commission_rate` decimal(5,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '佣金比例百分比',
  `deposit_rate` decimal(5,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '保证金比例百分比',
  `stock` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '库存量',
  `craft_standard` varchar(100) NOT NULL DEFAULT '' COMMENT '工艺标准',
  `sort` int(10) NOT NULL DEFAULT '0' COMMENT '排序权重',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=下架,1=上架',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_factory_id` (`factory_id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_status_sort` (`status`,`sort`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品任务池';

-- -----------------------------------------------------------
-- 4. fa_jj_order 居间人订单
-- 说明: 系统核心表，连接居间人、工厂、买家的纽带
-- 状态机: 0=待确认 1=待缴保证金 2=已缴保证金 3=待上传合同
--         4=履约执行中 5=待结算 6=已结算 7=已取消 8=已逾期
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_order` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `order_sn` varchar(30) NOT NULL DEFAULT '' COMMENT '订单编号',
  `agent_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '居间人user_id',
  `factory_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '工厂ID',
  `product_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '商品ID',
  `bid_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '竞标ID,直接下单为0',
  `product_name` varchar(100) NOT NULL DEFAULT '' COMMENT '商品名称',
  `cover_image` varchar(255) NOT NULL DEFAULT '' COMMENT '商品封面',
  `quantity` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '数量',
  `unit_price` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '单价',
  `total_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '订单总金额',
  `commission_rate` decimal(5,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '佣金比例百分比',
  `commission_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '佣金金额',
  `deposit_rate` decimal(5,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '保证金比例百分比',
  `deposit_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '保证金金额',
  `factory_bonus` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '工厂加成奖励',
  `logistics_rebate` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '物流返利',
  `buyer_company` varchar(100) NOT NULL DEFAULT '' COMMENT '买家公司名称',
  `buyer_address` varchar(255) NOT NULL DEFAULT '' COMMENT '买家地址',
  `buyer_contact` varchar(30) NOT NULL DEFAULT '' COMMENT '买家联系人',
  `buyer_phone` varchar(20) NOT NULL DEFAULT '' COMMENT '买家电话',
  `buyer_credit_code` varchar(30) NOT NULL DEFAULT '' COMMENT '统一社会信用代码',
  `buyer_tax_number` varchar(30) NOT NULL DEFAULT '' COMMENT '税号',
  `contract_upload_hours` int(10) unsigned NOT NULL DEFAULT '48' COMMENT '合同上传时限小时',
  `execution_hours` int(10) unsigned NOT NULL DEFAULT '168' COMMENT '履约时限小时',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待确认,1=待缴保证金,2=已缴保证金,3=待上传合同,4=履约执行中,5=待结算,6=已结算,7=已取消,8=已逾期',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  `deletetime` bigint(16) DEFAULT NULL COMMENT '软删除时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_sn` (`order_sn`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_factory_id` (`factory_id`),
  KEY `idx_bid_id` (`bid_id`),
  KEY `idx_status_createtime` (`status`,`createtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='居间人订单';

-- -----------------------------------------------------------
-- 5. fa_jj_order_log 订单状态日志
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_order_log` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `order_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_order.id',
  `from_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '变更前状态',
  `to_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '变更后状态',
  `description` varchar(255) NOT NULL DEFAULT '' COMMENT '操作描述',
  `operator_type` enum('agent','factory','system','admin') NOT NULL DEFAULT 'system' COMMENT '操作者类型',
  `operator_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '操作者ID',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单状态日志';

-- -----------------------------------------------------------
-- 6. fa_jj_deposit 保证金记录
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_deposit` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `order_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_order.id',
  `user_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '缴纳人user_id',
  `amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '保证金金额',
  `pay_type` tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '支付方式:1=微信,2=支付宝',
  `pay_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待支付,1=已支付,2=已退回',
  `trade_no` varchar(60) NOT NULL DEFAULT '' COMMENT '第三方交易号',
  `refund_time` bigint(16) DEFAULT NULL COMMENT '退回时间',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_pay_status` (`pay_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='保证金记录';

-- -----------------------------------------------------------
-- 7. fa_jj_contract 合同记录
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_contract` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `order_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_order.id',
  `file_url` varchar(255) NOT NULL DEFAULT '' COMMENT '合同文件地址',
  `file_name` varchar(100) NOT NULL DEFAULT '' COMMENT '文件名',
  `upload_deadline` bigint(16) DEFAULT NULL COMMENT '上传截止时间戳',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待上传,1=已上传,2=已过期',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='合同记录';

-- -----------------------------------------------------------
-- 8. fa_jj_logistics 物流跟踪
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_logistics` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `order_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_order.id',
  `logistics_type` tinyint(1) unsigned NOT NULL DEFAULT '1' COMMENT '类型:1=平台物流,2=自提',
  `company_name` varchar(50) NOT NULL DEFAULT '' COMMENT '物流公司',
  `tracking_no` varchar(50) NOT NULL DEFAULT '' COMMENT '物流单号',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '平台物流:0=待发货,1=已发货,2=运输中,3=已签收;自提:0=待提货,1=已提货',
  `timeline_json` text COMMENT '物流时间线JSON',
  `rebate_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '物流返利金额',
  `pickup_time` bigint(16) DEFAULT NULL COMMENT '提货时间',
  `pickup_note_url` varchar(255) NOT NULL DEFAULT '' COMMENT '提货单图片',
  `checklist_files` text COMMENT '验货单文件列表JSON',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='物流跟踪';

-- -----------------------------------------------------------
-- 9. fa_jj_commission 佣金记录
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_commission` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `order_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_order.id',
  `agent_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '居间人user_id',
  `order_no` varchar(30) NOT NULL DEFAULT '' COMMENT '订单编号',
  `product_name` varchar(100) NOT NULL DEFAULT '' COMMENT '商品名称',
  `company_name` varchar(100) NOT NULL DEFAULT '' COMMENT '买家公司',
  `total_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '佣金总金额',
  `base_commission` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '基础佣金',
  `factory_bonus` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '工厂加成',
  `logistics_rebate` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '物流返利',
  `pk_bonus` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT 'PK奖金',
  `red_packet` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '红包',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待结算,1=已结算',
  `settled_time` bigint(16) DEFAULT NULL COMMENT '结算时间',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_status_createtime` (`status`,`createtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='佣金记录';

-- -----------------------------------------------------------
-- 10. fa_jj_bid 竞标记录
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_bid` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `bid_sn` varchar(30) NOT NULL DEFAULT '' COMMENT '竞标编号',
  `agent_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '发起人user_id',
  `category_name` varchar(50) NOT NULL DEFAULT '' COMMENT '品类名称',
  `quantity` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '需求数量',
  `unit` varchar(20) NOT NULL DEFAULT '' COMMENT '单位',
  `expect_delivery` date DEFAULT NULL COMMENT '期望交货日期',
  `target_commission` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '目标佣金',
  `factory_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '参与工厂数',
  `quoted_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '已报价数',
  `buyer_company` varchar(100) NOT NULL DEFAULT '' COMMENT '买家公司',
  `buyer_address` varchar(255) NOT NULL DEFAULT '' COMMENT '买家地址',
  `buyer_contact` varchar(30) NOT NULL DEFAULT '' COMMENT '买家联系人',
  `buyer_phone` varchar(20) NOT NULL DEFAULT '' COMMENT '买家电话',
  `buyer_credit_code` varchar(30) NOT NULL DEFAULT '' COMMENT '统一社会信用代码',
  `buyer_tax_number` varchar(30) NOT NULL DEFAULT '' COMMENT '税号',
  `status` tinyint(1) NOT NULL DEFAULT '1' COMMENT '状态:1=竞标中,2=已完成,3=已过期',
  `expire_time` bigint(16) DEFAULT NULL COMMENT '截止时间',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_bid_sn` (`bid_sn`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_status_createtime` (`status`,`createtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='竞标记录';

-- -----------------------------------------------------------
-- 11. fa_jj_bid_quote 竞标工厂报价
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_bid_quote` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `bid_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_bid.id',
  `factory_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '工厂ID',
  `factory_name` varchar(100) NOT NULL DEFAULT '' COMMENT '工厂名称',
  `contract_price` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '合同报价',
  `delivery_date` date DEFAULT NULL COMMENT '交货日期',
  `commission_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '佣金金额',
  `fulfill_rate` decimal(5,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '履约率',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待报价,1=已报价,2=已过期',
  `selected` tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '是否中标:0=否,1=是',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_bid_id` (`bid_id`),
  KEY `idx_factory_id` (`factory_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='竞标工厂报价';

-- -----------------------------------------------------------
-- 12. fa_jj_red_packet 平台红包记录
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_red_packet` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `order_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联订单',
  `agent_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '居间人user_id',
  `order_no` varchar(30) NOT NULL DEFAULT '' COMMENT '订单编号',
  `amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '红包金额',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=待领取,1=已领取',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_status_createtime` (`status`,`createtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='平台红包记录';

-- -----------------------------------------------------------
-- 13. fa_jj_pk_pool PK奖池
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_pk_pool` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `total_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '奖池总金额',
  `start_date` date NOT NULL COMMENT '周期开始日期',
  `end_date` date NOT NULL COMMENT '周期结束日期',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '状态:0=进行中,1=已结算',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='PK奖池';

-- -----------------------------------------------------------
-- 14. fa_jj_pk_rank PK排名记录
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_pk_rank` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `pool_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '关联fa_jj_pk_pool.id',
  `agent_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '居间人user_id',
  `revenue_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '周期内业绩额',
  `prize_amount` decimal(12,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '获得奖金',
  `rank` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '排名',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_pool_id` (`pool_id`),
  KEY `idx_agent_id` (`agent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='PK排名记录';

-- -----------------------------------------------------------
-- 15. fa_jj_invite 分销推广关系
-- -----------------------------------------------------------
CREATE TABLE `fa_jj_invite` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `agent_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '居间人user_id',
  `invite_user_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '被邀请人user_id',
  `order_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '被邀请人完成订单数',
  `createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
  `updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_invite_user_id` (`invite_user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分销推广关系';
```

---

## 三、前端页面与后端 API / 数据表映射

| 前端页面 | API 接口 | 涉及数据表 |
|----------|---------|-----------|
| jj_auth | `xiluxc.jj_user/intermediaryAuth` | fa_user, fa_jj_agent_profile |
| jj_home | `xiluxc.jj_agent/dashboard` | fa_jj_agent_profile, fa_jj_commission, fa_jj_pk_pool |
| jj_profile | `xiluxc.user/profile` | fa_user |
| jj_products | `xiluxc.jj_product/list` | fa_jj_product, fa_jj_factory |
| jj_product_detail | `xiluxc.jj_product/detail` | fa_jj_product, fa_jj_factory |
| jj_buyer_form | `xiluxc.jj_order/submit` | fa_jj_order, fa_jj_product |
| jj_deposit | `xiluxc.jj_order/pay_deposit` | fa_jj_deposit, fa_jj_order |
| jj_contract | `xiluxc.jj_order/contract` | fa_jj_contract, fa_jj_order |
| jj_logistics | `xiluxc.jj_order/logistics` | fa_jj_logistics |
| jj_order_detail | `xiluxc.jj_order/detail` | fa_jj_order, fa_jj_deposit, fa_jj_contract, fa_jj_logistics |
| jj_orders | `xiluxc.jj_order/list` | fa_jj_order |
| jj_commission | `xiluxc.jj_commission/list` | fa_jj_commission |
| jj_bid_board | `xiluxc.jj_bid/list` | fa_jj_bid, fa_jj_bid_quote |
| jj_bid_detail | `xiluxc.jj_bid/detail` | fa_jj_bid, fa_jj_bid_quote |
| jj_bid_publish | `xiluxc.jj_bid/publish` | fa_jj_bid, fa_jj_bid_quote, fa_jj_factory |
| jj_red_packet | `xiluxc.jj_red_packet/list` | fa_jj_red_packet |
| jj_pk_pool | `xiluxc.jj_pk_pool/info` | fa_jj_pk_pool, fa_jj_pk_rank |
| jj_distribution | `xiluxc.jj_invite/info` | fa_jj_invite, fa_jj_agent_profile |

---

## 四、核心业务流转

### 4.1 直接接单流程

```
商品池浏览 (fa_jj_product)
    ↓
商品详情 → 点击"接单"
    ↓
填写买家信息 (jj_buyer_form)
    ↓
创建订单 (fa_jj_order, status=1)
    ↓
缴纳保证金 (fa_jj_deposit → 微信/支付宝)
    ↓ 支付成功
订单 status → 2 → 3
    ↓
上传合同 (fa_jj_contract)
    ↓ 上传成功
订单 status → 4（履约执行中）
    ↓
物流跟踪 (fa_jj_logistics)
    ↓ 签收/提货完成
订单 status → 5（待结算）
    ↓ 系统结算
生成佣金记录 (fa_jj_commission)，订单 status → 6
```

### 4.2 竞标流程

```
发起竞标 (fa_jj_bid, status=1)
    ↓ 选择工厂 + 填写需求 + 买家信息
等待工厂报价 (fa_jj_bid_quote)
    ↓ 倒计时到期或报价齐全
选择中标工厂 (bid_quote.selected=1)
    ↓
自动创建订单 (fa_jj_order, bid_id 关联)
    ↓
后续同"直接接单流程"
```

### 4.3 保证金冻结与退回

```
订单创建 → 计算保证金 = total_amount × deposit_rate
    ↓
缴纳 (fa_jj_deposit, pay_status=1)
    ↓
订单结算时 → 退回保证金 (pay_status=2, 记录 refund_time)
```

---

## 五、开发阶段规划

### 第一阶段：数据库建表 + 基础模型

- [ ] 执行 DDL 创建 15 张 `fa_jj_*` 表
- [ ] 创建 ThinkPHP Model 类（`app\common\model\jj\` 命名空间）
- [ ] 在模型中配置字段映射，API 输出时转换为前端所需的 camelCase
- [ ] 处理 fa_user 中已有的 camelCase 字段兼容

### 第二阶段：认证 + 用户模块

- [ ] `xiluxc.jj_user/intermediaryAuth` — 居间人认证接口（写入 fa_jj_agent_profile）
- [ ] `xiluxc.jj_agent/dashboard` — 首页仪表盘数据接口
- [ ] 完善 `xiluxc.user/profile` 支持居间人角色信息

### 第三阶段：商品 + 订单核心链路

- [ ] `xiluxc.jj_product/list` / `detail` — 商品池接口
- [ ] `xiluxc.jj_order/submit` — 创建订单（含买家信息）
- [ ] `xiluxc.jj_order/detail` / `list` — 订单详情与列表
- [ ] `xiluxc.jj_order/pay_deposit` — 保证金支付（对接微信/支付宝）
- [ ] `xiluxc.jj_order/contract` / `submit_contract` — 合同上传
- [ ] `xiluxc.jj_order/logistics` / `upload_checklist` — 物流跟踪
- [ ] `xiluxc.jj_order/urge_factory` — 催促工厂

### 第四阶段：竞标模块

- [ ] `xiluxc.jj_bid/publish` — 发起竞标
- [ ] `xiluxc.jj_bid/list` / `detail` — 竞标列表与详情
- [ ] `xiluxc.jj_bid/factory_list` — 工厂筛选列表
- [ ] `xiluxc.jj_bid/select_factory` — 选择中标工厂并自动转订单

### 第五阶段：激励 + 分销模块

- [ ] `xiluxc.jj_commission/summary` / `list` — 佣金统计与记录
- [ ] `xiluxc.jj_red_packet/summary` / `list` — 红包记录
- [ ] `xiluxc.jj_pk_pool/info` — PK 奖池与排名
- [ ] `xiluxc.jj_invite/info` — 分销推广与团队列表
- [ ] 佣金自动结算定时任务

### 第六阶段：管理后台

- [ ] 在 admin 模块添加居间人管理 CRUD（居间人列表、审核）
- [ ] 工厂管理 CRUD
- [ ] 商品管理 CRUD
- [ ] 订单管理（查看、状态干预）
- [ ] 竞标管理
- [ ] 奖池/红包配置

---

## 六、注意事项

1. **字段命名约定**：数据库使用 snake_case，API 输出使用 camelCase，在 Model 层通过 `$append` 和获取器做转换
2. **时间字段**：统一使用 bigint(16) 存储 Unix 时间戳，与现有表保持一致
3. **软删除**：订单表启用 `deletetime` 软删除，其余表视需求而定
4. **金额精度**：所有金额字段使用 `decimal(12,2)`，避免浮点精度问题
5. **fa_user 兼容**：已有的 camelCase 字段（roleType 等）保持现状，不做迁移，在相关模型中显式声明
6. **索引规划**：order_sn、bid_sn 建唯一索引；agent_id、factory_id、order_id 等外键建普通索引；status + createtime 建复合索引用于列表查询
7. **默认值**：所有 varchar 字段默认空字符串，数值字段默认 0 或 0.00，时间戳字段默认 NULL，与现有表风格一致
