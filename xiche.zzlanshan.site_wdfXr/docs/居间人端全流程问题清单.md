# 居间人端全流程问题清单

> 检查日期：2026-02-15
> 检查范围：居间人下单 → 缴纳保证金 → 合同上传 → 履约执行 → 结算到账 全流程

---

## 一、订单状态生命周期

```
0 待确认 → 1 待缴保证金 → 2 已缴保证金 → 3 合同上传中 → 4 履约执行中 → 5 待结算 → 6 已结算
                                                                                    ↘ 8 已逾期（违约）
                                                                       7 已取消
```

---

## 二、各环节 API 完整性

| 环节 | 状态转换 | API 端点 | 状态 |
|------|----------|----------|------|
| 居间人下单 | 0→1 | `jj_order/submit` / `batch_submit` | 正常 |
| 保证金详情 | — | `jj_order/deposit_info` / `batch_deposit_info` | 正常 |
| 缴纳保证金 | 1→2 | `jj_order/pay_deposit` / `pay_batch_deposit` | **有问题** |
| 工厂确认接单 | 0→1 | `fc_order/confirm` | 正常 |
| 工厂锁定佣金 | 1/2→3 | `fc_order/lock_commission` | 正常 |
| 合同状态查询 | — | `jj_order/contract_status` | 正常 |
| 上传合同 | 3→3（待审核） | `jj_order/submit_contract` | 正常 |
| 工厂审核合同 | 3→4 / 驳回 | `fc_order/review_contract` | 正常 |
| 上传付款凭证 | 4→4（待审核） | `jj_order/upload_payment_proof` | 正常 |
| 工厂审核凭证 | 4→5 / 驳回 | `fc_order/review_payment` | 正常 |
| 工厂确认发货 | 4→6（自动结算） | `fc_order/confirm_shipment` | 正常 |
| 工厂同意放款 | 5→6（结算） | `fc_order/release_payment` | 正常 |
| 违约结算 | 3/4→8 | `fc_order/fail_settle` | 正常 |
| 佣金汇总/列表 | — | `jj_commission/summary` / `list` | 正常 |
| 物流查询 | — | `jj_order/logistics` | 正常 |
| 催促工厂 | — | `jj_order/urge_factory` | **有问题** |

---

## 三、问题列表

### 问题 1：保证金支付未对接真实支付

- **严重程度**：严重（上线阻断）
- **涉及文件**：`application/api/controller/xiluxc/JjOrder.php` — `pay_deposit()` 方法（约第 275 行）
- **现状**：代码中有 TODO 注释 `// TODO: 对接实际支付（微信/支付宝），此处模拟支付成功`，当前在 debug 模式下直接模拟支付成功改状态，没有对接微信/支付宝实际支付。
- **对比**：工厂端充值（`FcWallet.php` 的 `create_recharge()` + `notify()`）已经对接了微信支付并有回调处理。
- **解决方案**：参照 `FcWallet.php` 的微信支付模式，为居间人保证金支付对接微信/支付宝，包括：
  1. 创建支付订单，调用微信/支付宝统一下单接口
  2. 前端拉起支付
  3. 后端实现支付回调 `notify()` 方法，在回调中确认支付成功后再改状态
  4. 批量支付（`pay_batch_deposit`）同样需要对接

---

### 问题 2：保证金退还只改状态，没有实际退款

- **严重程度**：严重（上线阻断）
- **涉及文件**：`application/api/controller/xiluxc/FcOrder.php`
  - `confirm_shipment()` 第 693-695 行
  - `release_payment()` 第 821-823 行
- **现状**：结算时保证金退还逻辑只是把 Deposit 的 `pay_status` 改为 `REFUNDED`：
  ```php
  Deposit::where('order_id', $orderId)->update([
      'pay_status' => Deposit::PAY_STATUS_REFUNDED,
  ]);
  ```
  没有调用 `User::money()` 把保证金金额退回居间人账户余额，也没有调用微信退款接口。
- **原因**：因为问题 1 中保证金支付是模拟的（没有真实扣款），所以退还也只标记了状态。
- **解决方案**：上线对接真实支付后，退还时需要：
  - 方案 A：调用微信/支付宝原路退款接口
  - 方案 B：调用 `User::money($depositAmount, $agentId, '保证金退还')` 退到居间人平台余额
  - 两种方案选其一，需要与产品确认

---

### 问题 3：佣金结算金额注释与代码不一致

- **严重程度**：中等（不影响功能，但需产品确认）
- **涉及文件**：
  - `application/api/controller/xiluxc/FcOrder.php` 第 775 行注释
  - `application/common/model/jj/Escrow.php` 第 28-30 行常量
- **现状**：`FcOrder.php` 代码注释写的是 `居间人到手 = commission × 80%（扣20%个税，不扣平台费）`，但 `Escrow.php` 中：
  ```php
  const TAX_RATE = 0;  // 暂不扣个税（居间人有企业/个人两种身份，税务另行处理）
  ```
  实际 `agent_settlement = commission × 100%`（全额到账），注释与实际执行结果不一致。
- **说明**：这不是 bug，税率常量为 0 说明税务方案尚未落地。但需要在上线前明确：
  1. 是否需要代扣个税？扣多少？
  2. 居间人是企业身份还是个人身份，分别如何处理？
  3. 确认后修改 `Escrow.php` 中的 `TAX_RATE` 常量

---

### 问题 4：没有自动违约结算定时任务

- **严重程度**：中等（影响业务闭环）
- **涉及文件**：无（缺少该功能）
- **现状**：
  - 合同上传截止（`contract_upload_deadline`）和催款截止（`payment_urge_deadline`）后，系统不会自动执行违约结算
  - 前端倒计时到期后只弹提示框，不触发后端操作
  - 后端的 `fc_order/fail_settle` 需要**工厂主动调用**才会执行违约结算
- **风险**：如果工厂不操作，超时订单会一直卡在 status=3 或 status=4，居间人保证金无法被处理，工厂佣金持续冻结。
- **解决方案**：创建 ThinkPHP 定时命令，例如 `php think jj:auto_settle`，定时扫描：
  1. `status=3` 且 `contract_upload_deadline < time()` 的订单 → 自动执行违约结算
  2. `status=4` 且 `payment_urge_deadline < time()` 的订单 → 自动执行违约结算
  3. 通过 crontab 每分钟执行一次

---

### 问题 5：催促工厂没有实际通知

- **严重程度**：低（功能体验问题）
- **涉及文件**：`application/api/controller/xiluxc/JjOrder.php` — `urge_factory()` 方法
- **现状**：该方法只记录了一条 OrderLog，前端返回"催促通知已发送"，但实际没有发送任何 SMS 短信或 APP 推送通知给工厂。
- **解决方案**：对接短信或推送服务，在调用时发送通知给工厂负责人。

---

### 问题 6：工厂锁定佣金 2 小时窗口期缺少自动封禁

- **严重程度**：低（功能缺失）
- **涉及文件**：`application/api/controller/xiluxc/FcOrder.php` — `lock_commission()` 方法（约第 338 行）
- **现状**：代码中有 TODO 注释 `// TODO: 触发工厂封禁1个月（需后端定时任务配合）`。工厂在居间人缴纳保证金后有 2 小时窗口期锁定佣金，超时应触发封禁，但此功能尚未实现。
- **解决方案**：在定时任务中增加扫描逻辑，检测超时未锁定佣金的工厂并执行封禁。

---

## 四、前端页面完整性

| 页面 | 用途 | 状态 |
|------|------|------|
| `jj_order_detail` | 订单详情（状态横幅、金额明细、三流进度、倒计时、操作按钮） | 已部署 |
| `jj_contract` | 合同上传 / 履约催款阶段 | 已部署 |
| `jj_deposit` | 保证金缴纳页面 | 已部署 |
| `jj_payment_proof` | 付款凭证上传页面 | 已部署 |
| `jj-orders-content` | 订单列表组件（带筛选、搜索） | 已部署 |
| `jj_main` | 主入口页（Tab 导航：订单、商品池、我的） | **未找到源码** |
| `jj_logistics` | 物流跟踪详情页 | **未找到源码** |
| `jj_wallet` | 钱包 / 佣金明细页 | **未找到源码** |

> 注：`jj_order_detail` 中有跳转到 `jj_logistics` 和 `jj_main` 的代码，如果这些页面不存在，点击对应按钮会导致白屏或跳转失败。

---

## 五、资金流总结

### 正常结算路径

```
居间人 → 缴纳保证金(commission × 1%) → [冻结在平台/待对接]
工厂   → 锁定佣金(commission + service_fee) → [冻结在工厂账户]
                         ↓ 结算时
工厂冻结金额 settle   → 佣金 100% 打入居间人 User.money（个税暂不扣）
保证金                → 标记 REFUNDED（实际退还待对接）
service_fee          → 平台收入
```

### 违约路径

```
保证金 50%   → 平台收取
保证金全额   → 赔付给工厂（recharge 到工厂账户）
工厂佣金     → 解冻退回工厂可用余额
居间人       → 得到 0（损失全部保证金）
```

---

## 六、优先级排序

| 优先级 | 问题 | 说明 |
|--------|------|------|
| P0 | 问题 1：保证金真实支付对接 | 上线必须，当前是模拟支付 |
| P0 | 问题 2：保证金真实退还 | 上线必须，当前只改状态 |
| P1 | 问题 4：自动违约结算定时任务 | 影响业务闭环，超时订单无法自动处理 |
| P1 | 前端缺失页面（jj_main/jj_logistics/jj_wallet） | 影响用户体验完整性 |
| P2 | 问题 3：佣金税率确认 | 需产品/财务确认后调整常量 |
| P2 | 问题 5：催促工厂通知 | 体验优化 |
| P2 | 问题 6：工厂超时封禁 | 功能完善 |

---

## 七、问题 2 / 4 / 6 修复记录

> 修复日期：2026-02-15

### 问题 2 修复：保证金退还实际到账

**涉及文件**: `application/api/controller/xiluxc/FcOrder.php`

**修改方案**: 采用方案 B — 退到居间人平台余额（`User::money()`），暂不对接微信原路退款。

**修改位置 1**: `confirm_shipment()` (约第 723-733 行)

修改前：
```php
Deposit::where('order_id', $orderId)->update([
    'pay_status' => Deposit::PAY_STATUS_REFUNDED,
]);
```

修改后：
```php
$deposit = Deposit::where('order_id', $orderId)
    ->where('pay_status', Deposit::PAY_STATUS_PAID)
    ->find();
if ($deposit) {
    $deposit->save(['pay_status' => Deposit::PAY_STATUS_REFUNDED]);
    $depositRefund = floatval($deposit['amount']);
    if ($depositRefund > 0) {
        User::money($depositRefund, $order['agent_id'], '订单' . $order['order_sn'] . '保证金退还');
    }
}
```

**修改位置 2**: `release_payment()` (约第 871-881 行) — 同上。

---

### 问题 4 修复：自动违约结算定时任务

**新增文件**: `application/command/JjAutoSettle.php`

**注册**: `application/command.php` 添加 `'app\command\JjAutoSettle'`

**命令**: `php think jj:auto_settle`

**扫描逻辑**:

1. **合同上传超时** (`status=3`): 扫描 `contract_upload_deadline > 0 且 < time()` 的订单，执行违约结算（复用 `fail_settle` 逻辑：保证金赔付工厂、平台收50%、退还工厂佣金+剩余服务费）
2. **催款超时** (`status=4`): 扫描 `payment_urge_deadline > 0 且 < time()` 的订单，同上
3. **工厂超时未锁定佣金** (`status=2`): 扫描保证金已缴纳超过2小时的订单（见问题6修复）

**并发安全**: 所有操作使用 `lock(true)` 行锁 + 状态重新校验，支持多实例安全执行。

**部署**: crontab 每分钟执行
```
* * * * * php /path/to/think jj:auto_settle >> /tmp/jj_auto_settle.log 2>&1
```

---

### 问题 6 修复：工厂超时封禁

**涉及文件**:

1. `application/api/controller/xiluxc/FcOrder.php` — `lock_commission()` (约第 337-339 行)
2. `application/command/JjAutoSettle.php` — `banFactoryAndCancelOrder()`

**修改 1 — lock_commission() 阻止超时操作**:

修改前：
```php
if (time() > $deadline) {
    // TODO: 触发工厂封禁1个月（需后端定时任务配合）
}
```

修改后：
```php
if (time() > $deadline) {
    $this->error('锁定佣金已超时（超过2小时），该订单将由系统自动处理');
}
```

**修改 2 — 定时任务自动封禁**:

在 `JjAutoSettle` 命令中新增扫描逻辑 `banFactoryAndCancelOrder()`：
- 扫描 `status=2` 且保证金缴纳时间超过2小时的订单
- 封禁工厂（`Factory.status = FROZEN`）
- 取消订单（`status → 7 已取消`）
- 退还保证金给居间人（`User::money()` + `Deposit.pay_status = REFUNDED`）
- 写入 OrderLog 记录
